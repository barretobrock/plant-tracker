{% macro render_map(datadata, boundaries, focus_color, needs_coordinates, shape_type) -%}
    <script defer>
        // The element that dictates the main svg type
        let id_name
        {% if shape_type is none %}
            var svg_type_elem = document.getElementById('shape_type');
            id_name = svg_type_elem.value;
        {% else %}
            id_name = '{{ shape_type }}';
        {% endif %}
        var is_polygon = id_name === 'polygon';

        function plotHandler(input_element, svg_element, is_polygon) {
            if (is_polygon) {
                // polygon
                svg_element.setAttribute('points', input_element.value);
            } else {
                // circle
                let splits = input_element.value.split(',');
                if (splits.length === 0 || splits[0] === '') {
                    svg_element.setAttribute('cx', "2000");
                } else {
                    svg_element.setAttribute('cx', splits[0]);
                }

                if (splits.length <= 1 || splits[1] === '') {
                    svg_element.setAttribute('cy', "2000");
                } else {
                    svg_element.setAttribute('cy', splits[1]);
                }
                if (splits.length < 3 || splits[2] === '') {
                    svg_element.setAttribute('r', "250");
                } else {
                    svg_element.setAttribute('r', splits[2]);
                }
            }
        }
        function plotPoints(elem) {
            var polymap = document.getElementById(id_name);
            plotHandler(elem, polymap, is_polygon)
        }
        window.addEventListener("load", function () {
            // Load the svg_type listener
            {% if shape_type is none %}
                svg_type_elem.onchange = function (event) {
                    id_name = event.target.value;
                    is_polygon = id_name === 'polygon';
                    if (is_polygon){
                        let prev_elem = document.getElementById('point')
                        prev_elem.removeAttribute('cx');
                        prev_elem.removeAttribute('cy');
                        prev_elem.removeAttribute('r');
                    } else {
                        let prev_elem = document.getElementById('polygon')
                        prev_elem.removeAttribute('points');
                    }
                }
            {% endif %}

            // Load the oninput listener
            var input_elem = document.getElementById('data');
            if (input_elem === null) {
                input_elem = document.getElementById('geodata');
            }
            input_elem.oninput = function(event) {
                return plotPoints(event.target);
            }

            // Plot the element initially on load (if any data)
            var polymap = document.getElementById(id_name);
            plotHandler(input_elem, polymap, is_polygon);
            {% if needs_coordinates %}
                // Load the mouse coordinates listener
                var map = document.getElementById('map');
                var mapParent = map.parentElement.parentElement;
                var coorddiv = document.getElementById('coords');
                map.onmousemove = function(event) {
                    var xRatio = 12780 / map.scrollWidth;
                    var yRatio = 35210 / map.scrollHeight;
                    // Starting point on page for x axis
                    var xBuff = (mapParent.clientWidth - map.clientWidth ) / 2;
                    var yBuff = (document.body.scrollHeight - map.scrollHeight - 56);
                    // console.log(event);
                    coorddiv.value = Math.round((event.pageX - xBuff) * xRatio) + ', ' + Math.round((event.pageY - yBuff) * yRatio);
                }
            {% endif %}
        })
    </script>
    {% if needs_coordinates %}
        <div id="coords-div">
            <span>Mouse coordinates<sup>(mm)</sup>: </span>
            <input id="coords" type="text" readonly/>
        </div>
    {% else %}
        <div>
            <input id="data" type="text" readonly hidden value="{{ data }}"/>
            <input id="shape_type" type="text" readonly hidden value="{{ shape_type }}"/>
        </div>
    {% endif %}
    <svg id="map" viewBox="0 0 12780 35210" style="border: 1px dotted cornflowerblue">
        {% set col = focus_color if focus_color else "magenta" %}
        {{ caller() }}
        <polygon id="polygon" points="" stroke="{{ col }}" stroke-width="10px" fill="{{ col }}" fill-opacity="0.2"></polygon>
        <circle id="point" stroke="{{ col }}" stroke-width="10px" fill="{{ col }}" fill-opacity="0.3"></circle>
        {% if data is iterable and data is not string %}
            {% for item in data %}
                {% if item.type == 'polygon' %}
                    <polygon points="{{ item.data }}" stroke="{{ item.col }}" stroke-width="10px" fill="item" fill-opacity="0.2">
                        <title>{{ item.name }}</title>
                    </polygon>
                {% else %}
                    <circle cx="{{ item.data.split(',')[0] }}" cy="{{ item.data.split(',')[1] }}" r="{{ item.data.split(',')[2] }}" stroke="{{ item.col }}" stroke-width="10px" fill="item" fill-opacity="0.3">
                        <title>{{ item.name }}</title>
                    </circle>
                {% endif %}
            {% endfor %}
        {% endif %}

        {% if boundaries %}
            {% for b in boundaries %}
                {% set stroke_color = "white" if b.type == 'region' else 'grey' %}
                <polygon points="{{ b.points }}" stroke="{{ stroke_color }}" stroke-width="5px" fill="white" fill-opacity="0.05">
                    <title>{{ b.name }}</title>
                </polygon>
            {% endfor %}
        {% endif %}
        <line id="focus-y1"></line>
        <line id="focus-y2"></line>
        <line id="focus-x1"></line>
        <line id="focus-x2"></line>
    </svg>
{%- endmacro %}
